<%- include('header') %>
<section class="shopping-cart spad">
        <div class="cart container">
          <div class="row">
                <div class="col-lg-8">
                    <% if(islogged == true) { %>
                    <% if(data.length > 0) { %>
                    <div class="shopping__cart__table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <% data.forEach(val => { %>
                                <tr>
                                    <td class="product__cart__item">
                                        <div class="product__cart__item__pic">
                                            <img src="<%= val.product.coverimage %>" alt="" class="h-28">
                                        </div>
                                        <div class="product__cart__item__text">
                                            <h6><%= val.product.productname %></h6>
                                            <h5 class="product-price">&#8377; <%= val.product.price.toLocaleString() %></h5>
                                        </div>
                                    </td>
                                    <td class="quantity__item">
                                    <div class="quantity-wrapper relative flex items-center max-w-[6rem]">
                                        <button type="button" id="decrement-button" data-input-counter-decrement="quantity-input" class="bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-lg px-2 h-10 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none">
                                            <svg class="w-3 h-3 text-gray-900 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 2">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h16"/>
                                            </svg>
                                        </button>
                                        <input type="text" id="quantity-input" data-input-counter data-input-counter-min="1" data-input-counter-max="20" aria-describedby="helper-text-explanation" class="input bg-gray-50 border-x-0 border-gray-300 h-10 text-center text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500 block w-full py-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" value="1" required />
                                        <button type="button" id="increment-button" data-input-counter-increment="quantity-input" class="bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-lg px-2 h-10 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none">
                                            <svg class="w-3 h-3 text-gray-900 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                    </td>
                                    <td class="cart__price">&#8377;</td>
                                    <td class="cart__close"><i class="fa fa-close"></i></td>
                                </tr>
                                <% }); %>
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn">
                                <a href="#">Continue Shopping</a>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="continue__btn update__btn">
                                <a href="#">Clear cart</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="cart__discount">
                        <h6>Discount codes</h6>
                        <form action="#">
                            <input type="text" placeholder="Coupon code">
                            <button type="submit">Apply</button>
                        </form>
                    </div>
                    <div class="cart__total">
                        <h6>Cart total</h6>
                        <ul>
                            <li class="cart_subtotal">Subtotal <span>$ 169.50</span></li>
                            <li class="cart_total">Total <span>$ 169.50</span></li>
                        </ul>
                        <a href="#" class="primary-btn">Proceed to checkout</a>
                    </div>
                </div>
            </div>
        </div>
        <% }else{ %>
                        <div class="w-full h-full">
                            <img src="/product_images/empty cart.png" class="!h-120 !w-120 mx-60" />
                        </div>
        <% } %>
    <% } %>
</section>
<script>
document.addEventListener("DOMContentLoaded", () => {
const islogged = "<%= islogged %>";
if(islogged == "false"){
    const parentdiv = document.querySelector(".cart.container");
    let localcartdata = localStorage.getItem("cart");
    localcartdata = localcartdata ? JSON.parse(localcartdata) : [];
    if(localcartdata.length > 0){
    
    const row = document.createElement("div");
    row.className = "row";

    const leftpart = document.createElement("div");
    leftpart.className = "col-lg-8";

    const tablewrapper = document.createElement("div");
    tablewrapper.className = "shopping__cart__table";

    const table = document.createElement("table");

    const thead = document.createElement("thead");
    const trhead = document.createElement("tr");
    ["Product","Quantity","Total", ""].forEach(heading => {
        const th = document.createElement("th");
        th.textContent = heading;
        trhead.appendChild(th);
    });
    thead.appendChild(trhead);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");

    let pids = [];

    localcartdata.map(a => {
        pids.push(a.product);
    });

    let products = [];

    async function fetchproducts() {
    await fetch(`/products/getproduct`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: pids })
    })
    .then(response => response.json())
    .then(responseproducts => {
    products.push(...responseproducts);
    products.forEach((dat,index) => {
        dat.quantity = localcartdata[index].quantity;
    });

    products.forEach(val => {

    const tr = document.createElement("tr");
    tr.setAttribute("data-pid",val._id);
    
    const td = document.createElement("td");
    td.className = "product__cart__item";

    const productpic = document.createElement("div");
    productpic.className = "product__cart__item__pic max-w-25";

    const pimg = document.createElement("img");
    pimg.src = `${val.coverimage}`;
    pimg.alt = "abc";

    productpic.appendChild(pimg);
    
    const text = document.createElement("div");
    text.className = "product__cart__item__text";

    const productname = document.createElement("h6");
    productname.textContent = `${val.productname}`;
    text.appendChild(productname);

    const price = document.createElement("h5");
    price.id = "product-price";
    price.className = "product-price";
    price.textContent = `₹ ${val.price.toLocaleString()}`;
    text.appendChild(price);

    const tdqty = document.createElement("td");
    tdqty.className = "quantity__item";

    const divqty = document.createElement("div");
    divqty.className = "quantity-wrapper relative flex items-center max-w-[6rem]";

    const decbutton = document.createElement("button");
    decbutton.type = "button";
    decbutton.id = "decrement-button";
    decbutton.setAttribute("data-input-counter-decrement", "quantity-input");
    decbutton.setAttribute("data-input-counter-min", "1");   
    decbutton.className = "bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-lg px-2 h-10 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none";

    const svgdata = "http://www.w3.org/2000/svg";

    const decsvg = document.createElementNS(svgdata, "svg");
    decsvg.setAttribute("class", "w-3 h-3 text-gray-900 dark:text-white");
    decsvg.setAttribute("aria-hidden", "true");
    decsvg.setAttribute("xmlns", svgdata);
    decsvg.setAttribute("fill", "none");
    decsvg.setAttribute("viewBox", "0 0 18 2");

    const path = document.createElementNS(svgdata, "path");
    path.setAttribute("stroke", "currentColor");
    path.setAttribute("stroke-linecap", "round");
    path.setAttribute("stroke-linejoin", "round");
    path.setAttribute("stroke-width", "2");
    path.setAttribute("d", "M1 1h16");

    decsvg.appendChild(path);
    decbutton.appendChild(decsvg);

    const input = document.createElement("input");
    input.type = "text";
    input.id = "quantity-input";
    input.setAttribute("data-input-counter", "1");
    input.setAttribute("data-input-counter-min", "1");
    input.setAttribute("data-input-counter-max", "20");
    input.setAttribute("aria-describedby","helper-text-explanation");
    input.className = "input bg-gray-50 border-x-0 border-gray-300 h-10 text-center text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500 block w-full py-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500";
    input.value = val.quantity;
    input.required = true;

    const incbutton = document.createElement("button");
    incbutton.type = "button";
    incbutton.id = "increment-button";
    incbutton.setAttribute("data-input-counter-increment", "quantity-input");
    incbutton.className = "input bg-gray-100 dark:bg-gray-700 dark:hover:bg-gray-600 dark:border-gray-600 hover:bg-gray-200 border border-gray-300 rounded-lg px-2 h-10 focus:ring-gray-100 dark:focus:ring-gray-700 focus:ring-2 focus:outline-none";

    const incsvg = document.createElementNS(svgdata, "svg");
    incsvg.setAttribute("class", "w-3 h-3 text-gray-900 dark:text-white");
    incsvg.setAttribute("aria-hidden", "true");
    incsvg.setAttribute("xmlns", svgdata);
    incsvg.setAttribute("fill", "none");
    incsvg.setAttribute("viewBox", "0 0 18 18");

    const incpath = document.createElementNS(svgdata, "path");
    incpath.setAttribute("stroke", "currentColor");
    incpath.setAttribute("stroke-linecap", "round");
    incpath.setAttribute("stroke-linejoin", "round");
    incpath.setAttribute("stroke-width", "2");
    incpath.setAttribute("d", "M9 1v16M1 9h16");

    incsvg.appendChild(incpath);
    incbutton.appendChild(incsvg);

    divqty.appendChild(decbutton);
    divqty.appendChild(input);
    divqty.appendChild(incbutton);
    tdqty.appendChild(divqty);

    const tdPrice = document.createElement("td");
    tdPrice.id = "cart__price";
    tdPrice.className = "cart__price";
    tdPrice.textContent = `₹ ${val.price.toLocaleString()}`;

    const tdClose = document.createElement("td");
    tdClose.className = "cart__close";
    const iClose = document.createElement("i");
    iClose.className = "fa fa-close";
    tdClose.appendChild(iClose);

    td.appendChild(productpic);
    td.appendChild(text);
    tr.appendChild(td);
    tr.appendChild(tdqty);
    tr.appendChild(tdPrice);
    tr.appendChild(tdClose);

    tbody.appendChild(tr);
    });

    let newqtys = [];
    function updateproductqty(){
    const input = document.querySelectorAll("#quantity-input");
    newqtys = [];
    input.forEach(dat => {
       newqtys.push(parseInt(...dat.value));
    });
    localcartdata.forEach((val,index) => {
        val.quantity = newqtys[index];
    });
    localStorage.setItem("cart", JSON.stringify(localcartdata));
    }

    function deletecartitem(){
        const cartitem = document.querySelectorAll("tbody tr");
        cartitem.forEach(val => {
            val.querySelector(".cart__close").addEventListener("click", () => {
                localcartdata = localcartdata.filter(p => p.product !== val.dataset.pid);
                localStorage.setItem("cart", JSON.stringify(localcartdata));
                val.remove();
                updatetotals();
                if(localcartdata.length < 1){
                console.log("thuu");
                    const div = document.createElement("div");
                    div.className = "w-full h-full";

                    const img = document.createElement("img");
                    img.className = "!h-120 !w-120 mx-60";
                    img.src = "/product_images/empty cart.png";

                    div.appendChild(img);
                    parentdiv.appendChild(div);
                }
            });
        });
    }

    updateproductqty();
    updateprice();
    updatetotals();
    deletecartitem();

    document.querySelectorAll(".quantity-wrapper").forEach((wrapper) => {
    const input = wrapper.querySelector("[data-input-counter]");
    const decrementBtn = wrapper.querySelector("[data-input-counter-decrement]");
    const incrementBtn = wrapper.querySelector("[data-input-counter-increment]");

    const min = parseInt(input.dataset.inputCounterMin) || 1;
    const max = parseInt(input.dataset.inputCounterMax) || Infinity;

    // Decrement
    decrementBtn.addEventListener("click", () => {
      let current = parseInt(input.value) || min;
      if (current > min) {
        input.value = current - 1;
      }
      input.dispatchEvent(new Event("input"));
    });

    // Increment
    incrementBtn.addEventListener("click", () => {
      let current = parseInt(input.value) || min;
      if (current < max) {
        input.value = current + 1;
      }
      input.dispatchEvent(new Event("input"));
    });

    // Validate manual typing
    input.addEventListener("input", () => {
      let value = parseInt(input.value) || min;
      if (value < min) value = min;
      if (value > max) value = max;
      input.value = value;
    });
    });
    function updateprice(){
    const cartitem = document.querySelectorAll("tbody tr");
    cartitem.forEach(val => { 
    const input = val.querySelector(".input");
    const price = val.querySelector(".cart__price");
    const p_price = val.querySelector(".product-price");
    function updaterowtotal() {
    const total = parseInt(p_price.innerText.replace(/\D/g, "")) * parseInt(input.value || 0);
    price.innerText = `₹ ${total.toLocaleString()}`;
    }
    input.addEventListener("input", () => {
        const p_price = val.querySelector(".product-price");
        const price = val.querySelector(".cart__price");
        const total = parseInt(p_price.innerText.replace(/\D/g, "")) * parseInt(event.target.value);
        price.innerText = `₹ ${total.toLocaleString()}`;
        updateproductqty();
        updatetotals();
    });
    updaterowtotal();
    });
    }
    updateprice();
    })
    .catch(error => {
        console.error('Error fetching products:', error);
    })
    };
    fetchproducts();

    const colRight = document.createElement("div");
    colRight.className = "col-lg-4";

    const discountDiv = document.createElement("div");
    discountDiv.className = "cart__discount";
    const h6Discount = document.createElement("h6");
    h6Discount.textContent = "Discount codes";
    const form = document.createElement("form");
    form.action = "#";
    const inputCoupon = document.createElement("input");
    inputCoupon.type = "text";
    inputCoupon.placeholder = "Coupon code";
    const btnApply = document.createElement("button");
    btnApply.type = "submit";
    btnApply.textContent = "Apply";
    form.appendChild(inputCoupon);
    form.appendChild(btnApply);
    discountDiv.appendChild(h6Discount);
    discountDiv.appendChild(form);
    colRight.appendChild(discountDiv);

    const totalDiv = document.createElement("div");
    totalDiv.className = "cart__total";
    const h6Total = document.createElement("h6");
    h6Total.textContent = "Cart total";
    const ul = document.createElement("ul");
    const liSubtotal = document.createElement("li");
    liSubtotal.className = "cart_subtotal";
    liSubtotal.innerHTML = "";
    const liTotal = document.createElement("li");
    liTotal.innerHTML = "";
    liTotal.className = "cart_total";
    ul.appendChild(liSubtotal);
    ul.appendChild(liTotal);
    const checkoutBtn = document.createElement("a");
    checkoutBtn.href = "#";
    checkoutBtn.className = "primary-btn";
    checkoutBtn.textContent = "Proceed to checkout";
    totalDiv.appendChild(h6Total);
    totalDiv.appendChild(ul);
    totalDiv.appendChild(checkoutBtn);
    colRight.appendChild(totalDiv);

    table.appendChild(tbody);
    tablewrapper.appendChild(table);
    leftpart.appendChild(tablewrapper);

    const rowBtn = document.createElement("div");
    rowBtn.className = "row";

    const colBtn1 = document.createElement("div");
    colBtn1.className = "col-lg-6 col-md-6 col-sm-6";
    const continueBtn = document.createElement("div");
    continueBtn.className = "continue__btn";
    const aContinue = document.createElement("a");
    aContinue.href = "/shop";
    aContinue.textContent = "Continue Shopping";
    continueBtn.appendChild(aContinue);
    colBtn1.appendChild(continueBtn);
    rowBtn.appendChild(colBtn1);

    const colBtn2 = document.createElement("div");
    colBtn2.className = "col-lg-6 col-md-6 col-sm-6";
    
    const updateBtnDiv = document.createElement("div");
    updateBtnDiv.className = "continue__btn update__btn";
    
    const aUpdate = document.createElement("a");
    aUpdate.href = "#";
    aUpdate.innerHTML = 'clear cart';
    updateBtnDiv.appendChild(aUpdate);
    colBtn2.appendChild(updateBtnDiv);
    rowBtn.appendChild(colBtn2);

    row.appendChild(leftpart);
    row.appendChild(colRight);

    function updatetotals(){
    const productprices = document.querySelectorAll(".cart__price");
    let ppvalues = [];
    productprices.forEach(dat => {
        const price = parseInt(dat.innerText.replace(/\D/g, ""));
        ppvalues.push(price);
    });
    let ppsum = 0;
    for(const p of ppvalues){
        ppsum += p;
    }

    let subtotal = document.querySelector(".cart_subtotal");
    let total = document.querySelector(".cart_total");
    const cartitem = document.querySelectorAll("tbody tr");
    subtotal.innerText = `Subtotal : ₹ ${ppsum}`;
    total.innerText = `Total : ₹ ${ppsum}`;
    let prices = [];
    cartitem.forEach(val => {
        const cartprice = parseInt(val.querySelector(".cart__price").innerText.replace(/\D/g, ""));
        prices.push(cartprice);
        let sum = 0;
    for(const ele of prices){
        sum += ele;
    }
    subtotal = document.querySelector(".cart_subtotal");
    total = document.querySelector(".cart_total");
    subtotal.innerText = `Subtotal: ₹ ${sum.toLocaleString()}`;
    total.innerHTML = `Total: ₹ ${sum.toLocaleString()}`;
    });
}
    parentdiv.appendChild(row);
    parentdiv.appendChild(rowBtn);
    }else{
    const div = document.createElement("div");
    div.className = "w-full h-full";

    const img = document.createElement("img");
    img.className = "!h-120 !w-120 mx-60";
    img.src = "/product_images/empty cart.png";

    div.appendChild(img);
    parentdiv.appendChild(div);
    }
}else{
document.querySelectorAll(".quantity-wrapper").forEach((wrapper) => {

    const input = wrapper.querySelector("[data-input-counter]");
    const decrementBtn = wrapper.querySelector("[data-input-counter-decrement]");
    const incrementBtn = wrapper.querySelector("[data-input-counter-increment]");

    const min = parseInt(input.dataset.inputCounterMin) || 1;
    const max = parseInt(input.dataset.inputCounterMax) || Infinity;

    decrementBtn.addEventListener("click", () => {
      let current = parseInt(input.value) || min;
      if (current > min) {
        input.value = current - 1;
      }
      input.dispatchEvent(new Event("input"));
    });

    incrementBtn.addEventListener("click", () => {
      let current = parseInt(input.value) || min;
      if (current < max) {
        input.value = current + 1;
      }
      input.dispatchEvent(new Event("input"));
    });

    input.addEventListener("input", () => {
      let value = parseInt(input.value) || min;
      if (value < min) value = min;
      if (value > max) value = max;
      input.value = value;
    });
    });

    function updateprice(){
    const cartitem = document.querySelectorAll("tbody tr");
    cartitem.forEach(val => { 
    const input = val.querySelector(".input");
    const price = val.querySelector(".cart__price");
    const p_price = val.querySelector(".product-price");
    const total = parseInt(p_price.innerText.replace(/\D/g, "")) * parseInt(input.value);
    price.innerText = `₹ ${total.toLocaleString()}`;
    function updaterowtotal() {
    const total = parseInt(p_price.innerText.replace(/\D/g, "")) * parseInt(input.value || 0);
    price.innerText = `₹ ${total.toLocaleString()}`;
    }
    input.addEventListener("input", () => {
        const p_price = val.querySelector(".product-price");
        const price = val.querySelector(".cart__price");
        const total = parseInt(p_price.innerText.replace(/\D/g, "")) * parseInt(event.target.value);
        price.innerText = `₹ ${total.toLocaleString()}`;
        updateproductqty();
        updatetotals();
    });
    updaterowtotal();
    });
    }
    updateprice();

    function updateproductqty(){
    const input = document.querySelectorAll("#quantity-input");
    
    // newqtys = [];
    // input.forEach(dat => {
    //    newqtys.push(parseInt(...dat.value));
    // });
    // localcartdata.forEach((val,index) => {
    //     val.quantity = newqtys[index];
    // });
    // localStorage.setItem("cart", JSON.stringify(localcartdata));
    }

    updateproductqty();

    function updatetotals(){
    const productprices = document.querySelectorAll(".cart__price");
    let ppvalues = [];
    productprices.forEach(dat => {
        const price = parseInt(dat.innerText.replace(/\D/g, ""));
        ppvalues.push(price);
    });
    let ppsum = 0;
    for(const p of ppvalues){
        ppsum += p;
    }

    let subtotal = document.querySelector(".cart_subtotal");
    let total = document.querySelector(".cart_total");
    const cartitem = document.querySelectorAll("tbody tr");
    subtotal.innerText = `Subtotal : ₹ ${ppsum}`;
    total.innerText = `Total : ₹ ${ppsum}`;
    let prices = [];
    cartitem.forEach(val => {
        const cartprice = parseInt(val.querySelector(".cart__price").innerText.replace(/\D/g, ""));
        prices.push(cartprice);
        let sum = 0;
    for(const ele of prices){
        sum += ele;
    }
    subtotal = document.querySelector(".cart_subtotal");
    total = document.querySelector(".cart_total");
    subtotal.innerText = `Subtotal: ₹ ${sum.toLocaleString()}`;
    total.innerHTML = `Total: ₹ ${sum.toLocaleString()}`;
    });
}
updatetotals();
}
});
</script>
<%- include('footer') %>